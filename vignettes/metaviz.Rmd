---
title: "Exploring and visualizing your meta-analytic data with *R* package **metaviz**"
author: "Michael Kossmeier, Ulrich S. Tran, and Martin Voracek (Department of Basic Psychological Research and Research Methods, School of Psychology, University of Vienna, Austria)"
date: "`r Sys.Date()`" 
output: 
    rmarkdown::html_vignette:
      toc: true
      depth: 3
vignette: >
  %\VignetteIndexEntry{metaviz}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, echo = FALSE}
knitr::opts_chunk$set(include = TRUE, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE, 
                      fig.width = 8, fig.asp = 0.618, out.width = "100%", fig.align = "center", 
                      cache = T)
```

The *R* package **metaviz** contains functions to create visually appealing plots of meta-analytic data using **ggplot2**. Many options to flexibly customize the visual appearence and statistical information displayed are provided. **metaviz**  currently includes functions to create forest plots (`viz_forest`), funnel plots (`viz_forest`), and to conduct visual funnel plots inference (`funnelinf`). See the documentation for more details and relevant references. 

This vignette is a tutorial for the use of **metaviz** to plot various forms of forest plots as well as funnel plots and presents some of its main features.

In the following, we use two different example datasets distributed with the package **metaviz**. The dataset `mozart` includes a published meta-analysis using the Cohen d metric (Pietschnig, Voracek, & Formann, 2010), `mozart` contains data for a meta-analysis using correlation coefficents (Pietschnig et al., 2015), and `exrehab` contains data of a published meta-analysis with dichomtous outcomes using risk ratios as effect size (Anderson et al. 2016). More details can be found in the respective help files (`help(mozart)`, `help(brainvol)`, `help(exrehab)`).

The main input of functions in package **metaviz** is a data.frame or matrix with the study effect sizes in the first column and the respective standard errors in the second column. Alternatively, the output of the function `rma.uni` from *R* package [**metafor**](https://CRAN.R-project.org/package=metafor) can be supplied as input.

First, the *R* package **metaviz** needs to be installed and attached within the *R* environment.
```{r}
library(metaviz)
```


# Creating forest plot variants with function viz_forest
The `viz_forest` is the main function in **metaviz** to create forest plots and their variants. Many options to visually customize the forest plot are provided (see, `help(viz_forest)`)

```{r}
viz_forest(x = mozart[1:10, c("d", "se")], study_labels = mozart[1:10, c("study_name")],
           summary_label = "Summary effect", xlab = "Cohen d")
```

## Forest plot variants: rainforest plot and thick forest plots

In addtion to traditional forest plots, rainforest plots as well as the thick forest plots can be created via the  `type` argument. Rainforest and thick forest plots are two variants and enhancements of the classical forest plot recently proposed by Schild and Voracek (2015). Both variants give more visual emphasis to large studies (with short confidecne intervals and more weight in the meta-analysis), while small studies (with wide confidence intervals and less weight in the meta-analysis) are visually less dominant. For furhter details see `help(viz_rainforest)` and `help(viz_thickforest)`.

```{r, dev='CairoPNG'}
viz_forest(x = mozart[1:10, c("d", "se")], study_labels = mozart[1:10, c("study_name")],
           summary_label = "Summary effect", xlab = "Cohen d", type = "rain")
```

```{r}
viz_forest(x = mozart[1:10, c("d", "se")], study_labels = mozart[1:10, c("study_name")],
           summary_label = "Summary effect", xlab = "Cohen d", type = "thick", method = "FE")
```


The `method` argument controls the meta-analytic model (fixed effect or random effects model). Changing `method` from a fixed effect to a random effects model changes the estimated summary effect and meta-analytic weights assigned to each study.
```{r, dev='CairoPNG'}
viz_forest(x = mozart[1:10, c("d", "se")], study_labels = mozart[1:10, c("study_name")],
           summary_label = "Summary effect", xlab = "Cohen d", type = "rain", method = "DL")
```

## Subgroup analysis
The `viz_forest` function is able to use a categorical moderator variable to visualize a subgroup analysis. This is done via the `group` argument, a factor which corresponds to the subgroup membership of each study. We use the dichotomous moderator "rr_lab" to compute and visualize separate meta-analyses. In the case of subgroup analysis, the `summary_label` argument can be a vector containing names for all subgroups, arranged in the order of the levels of `group`.
```{r, dev='CairoPNG'}
viz_forest(x = mozart[1:10, c("d", "se")], 
           group = mozart[1:10, "rr_lab"], 
           study_labels = mozart[1:10, "study_name"], 
           summary_label = c("Summary (rr_lab = no)", "Summary (rr_lab = yes)"), 
           xlab = "Cohen d",
           col = "Greys",
           type = "rain")
```

## Aligning tables with study and/or summary information
The `viz_forest` function was developed to allow aligning a table to the forest plot containg study or summary information. First, textual annotation of effect sizes and confidence intervals can be optionally displayed with the argument `annotate_CI = TRUE`. 

```{r, dev='CairoPNG'}
viz_forest(x = mozart[1:10, c("d", "se")], 
           group = mozart[1:10, "rr_lab"],
           study_labels = mozart[1:10, "study_name"], 
           summary_label = c("Summary (rr_lab = no)", "Summary (rr_lab = yes)"), 
           xlab = "Cohen d", 
           type = "thick",
           annotate_CI = TRUE)
```

Second, arbitrary study information can be supplied as data.frame with the argument `study_table`. 
This data.frame can contain several variables to be aligned as columns and should contain one row
for each study in the meta-analysis.

To illustrate, we might be interested to align a table with the number of events observed in each study of data set `exrehab`.
```{r}
study_table <- data.frame(
  eventsT = paste(exrehab$ai, "/", exrehab$ai + exrehab$bi, sep = ""),
  eventsC = paste(exrehab$ci, "/", exrehab$ci + exrehab$di, sep = ""))
head(study_table)
```

We might also want to include the sum of all events as summary information. This can be done with the `summary_table` argument. `summary_table` should be a data.frame with number of rows equal to the number of subgroups.

```{r}
summary_table <- data.frame(
    eventsT = paste(sum(exrehab$ai), "/", sum(exrehab$ai + exrehab$bi), sep = ""),
    eventsC = paste(sum(exrehab$ci), "/", sum(exrehab$ci + exrehab$di), sep = ""))
head(summary_table)
```



```{r, fig.asp = 0.5, fig.width = 10}
viz_forest(x = exrehab[, c("logrr", "logrr_se")], type = "classic",
study_labels = exrehab[, "study_name"], col = "Greys",
annotate_CI = T, xlab = "logRR", 
study_table = study_table,
summary_table = summary_table,
table_headers = c("Events (T)", "Events (C)"))
```


## Transforming the x axis labels
For some effect sizes it is good practice to transform the labels of the x-axis, such that they displaye effects on their original scale (e.g., log risk ratios as risk ratios). This can be conventiently done with the argument `x_trans_function`.


```{r, fig.asp = 0.5, fig.width = 10}
viz_forest(x = exrehab[, c("logrr", "logrr_se")], type = "classic",
study_labels = exrehab[, "study_name"], col = "Greys",  
annotate_CI = T,
study_table = study_table,
summary_table = summary_table,
table_headers = c("Events (T)", "Events (C)"),
x_trans_function = exp, xlab = "RR")
```


# Creating funnel plots with viz_funnel

```{r, echo = FALSE}
knitr::opts_chunk$set(include = TRUE, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE, 
                      fig.width = 5, fig.asp = 0.9, out.width = "60%", fig.align = "center", 
                      cache = T)
```

The function `viz_funnel` is capable to create a large set of different funnel plot variants. Options for several graphical augmentations (e.g., confidence, significance, and addtional evidence contours; choice of the ordinate; study_subgroups), and different statistical information displayed are provided (Egger's regression line, and imputed studies by, as well as the adjusted summary effect from, the trim-and-fill method). See `help(viz_funnel)` for furhter details.

By default significance contours and 95% confidence contours (fixed effect model) are shown.
```{r, dev='CairoPNG'}
viz_funnel(brainvol[, c("z", "z_se")])
```

In this meta-analyis Fisher's z values are used. It is convenient to show Fisher's z values on their original scale (correaltions) using `x_trans_function`. The meta-analytic model can be changed to a random effects model using `method`. The ordinate can be set to precison with the `y_axis` argument.
```{r, dev='CairoPNG'}
viz_funnel(brainvol[, c("z", "z_se")],
           y_axis = "precision",
           method = "DL",
           contours_col = "Greys",
           xlab = "r", x_trans_function = tanh, x_breaks = atanh(c(-0.9, -0.7, -0.3, 0, 0.3, 0.7, 0.9)))
```

## Trim-and-fill, Egger's regression
Showing imputed studies by the trim and fill method, the adjusted summary effect, as well as egger's regression line can help to assess funnel plot asymmetry.

```{r, dev='CairoPNG'}
viz_funnel(exrehab[, c("logrr", "logrr_se")], 
           contours_col = "Greys",
           trim_and_fill = TRUE, trim_and_fill_side = "right", 
           egger = TRUE)
```

## Addtional evidence contours
Two different additional evidence contours are available, helpoing to assess the robustness of the meta-analytic restult. These contours show the effect of one hypothetical new study (with a certain effect size and standard error) on the meta-analysis (given a certain `method`).

First, `addev_contours_sig` show where a new study has to fall such that the updated meta-analytic summary effect is signifcant (or not).

```{r, dev='CairoPNG'}
viz_funnel(mozart[1:10, c("d", "se")], sig_contours = FALSE, addev_contours_sig = TRUE)
```

Second, `addev_contours_b` show where a new study has to fall such that the updated meta-analytic summary effect has a certain magniute of interest.
```{r, dev='CairoPNG'}
viz_funnel(mozart[1:10, c("d", "se")], sig_contours = FALSE, addev_contours_b = c(0.2, 0.3, 0.4))
```

# References

Anderson, L., Oldridge, N., Thompson, D. R., Zwisler, A. D., Rees, K., Martin, N., & Taylor, R. S. (2016). Exercise-based cardiac rehabilitation for coronary
heart disease: Cochrane systematic review and meta-analysis. _Journal of the American College of Cardiology_, _67_, 1-12.

Pietschnig, J., Penke, L., Wicherts, J. M., Zeiler, M., & Voracek, M. (2015). Meta-analysis of associations between human brain volume and intelligence differences: How strong are they and what do they mean?. _Neuroscience & Biobehavioral Reviews_, _57_, 411-432.

Pietschnig, J., Voracek, M., & Formann, A. K. (2010). Mozart effect-Shmozart effect: A meta-analysis. _Intelligence_, _38_, 314-323.

Schild, A. H., & Voracek, M. (2015). Finding your way out of the forest without a trail of bread crumbs: Development and evaluation of two novel displays of forest plots. _Research Synthesis Methods_, _6_, 74-86.

# Contact
Questions, ideas, criticism: michael.kossmeier@univie.ac.at.

